#!/bin/bash
# TemplateGenerator - Script to create multiple Proxmox templates (minimal, classic flow)

# Install the tool we need for image customization (will prompt/abort if PVE blocks it)
apt install -y libguestfs-tools

# Ensure virt-customize is available before proceeding
if ! command -v virt-customize >/dev/null 2>&1; then
    echo "❌ 'virt-customize' not found. Make sure 'libguestfs-tools' is installed successfully, then re-run."
    exit 1
fi

# Quiet/verbose toggle for commands
DEBUG_MODE=false
run_cmd() {
    if [ "$DEBUG_MODE" = true ]; then
        "$@"
    else
        "$@" >/dev/null 2>&1
    fi
}

# Simple progress indicator
show_progress() {
    local current_step=$1
    local total_steps=6
    local progress=$(( (current_step * 100) / total_steps ))
    echo -ne "Progress: ${progress}%\r"
}

# Remove an existing VMID if present
delete_existing_vm() {
    local vmid=$1
    local name=$2
    if qm status "$vmid" &>/dev/null; then
        echo "Deleting ${name}..."
        run_cmd qm stop "$vmid"
        run_cmd qm destroy "$vmid" --destroy-unreferenced-disks
    fi
}

# Create one template from URL
create_template() {
    local vmid=$1
    local name=$2
    local image_url=$3
    local image_file="${name}-cloudimg.img"

    delete_existing_vm "$vmid" "$name"
    echo "Generating ${name}..."

    # 1) Download image
    run_cmd wget -q "${image_url}" -O "${image_file}"
    show_progress 1

    # 2) Inject qemu-guest-agent
    run_cmd virt-customize -a "${image_file}" --install qemu-guest-agent
    show_progress 2

    # 3) Create VM shell (fix: --cores)
    run_cmd qm create "${vmid}" --memory 2048 --cpu host --cores 2 --name "${name}" --net0 virtio,bridge=vmbr0
    show_progress 3

    # 4) Import disk into local-lvm
    run_cmd qm disk import "${vmid}" "${image_file}" local-lvm
    show_progress 4

    # 5) Configure storage/boot/agent
    run_cmd qm set "${vmid}" --scsihw virtio-scsi-pci --scsi0 local-lvm:vm-"${vmid}"-disk-0,discard=on,ssd=1
    run_cmd qm disk resize "${vmid}" scsi0 8G
    run_cmd qm set "${vmid}" --ide2 local-lvm:cloudinit
    run_cmd qm set "${vmid}" --boot c --bootdisk scsi0
    run_cmd qm set "${vmid}" --agent enabled=1
    show_progress 5

    # 6) Convert to template
    run_cmd qm template "${vmid}"
    show_progress 6

    echo -ne "Progress: 100%\n"
    echo "✅ ${name} template created successfully (VMID ${vmid})."
}

# ---- Define the templates you want ----
create_template 8000 "Ubuntu24.04Template" "https://cloud-images.ubuntu.com/noble/current/noble-server-cloudimg-amd64.img"
# create_template 7999 "Ubuntu24.10Template" "https://cloud-images.ubuntu.com/oracular/current/oracular-server-cloudimg-amd64.img"
# create_template 7998 "Ubuntu22.04Template" "https://cloud-images.ubuntu.com/jammy/current/jammy-server-cloudimg-amd64.img"
# create_template 7997 "Debian11Template" "https://cdimage.debian.org/images/cloud/bullseye/latest/debian-11-generic-amd64.qcow2"
# create_template 7996 "Debian12Template" "https://cloud.debian.org/images/cloud/bookworm/latest/debian-12-generic-amd64.qcow2"
# create_template 7995 "Fedora42Template" "https://download.fedoraproject.org/pub/fedora/linux/releases/42/Cloud/x86_64/images/Fedora-Cloud-Base-Generic-42-1.1.x86_64.qcow2"

echo "All templates created successfully."
